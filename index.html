<!DOCTYPE html>
<html>
  <head>
    <style>
      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-family: Courier New, monospace;
      }
    </style>
  </head>
  <body>
    <h1>My Simple Action</h1>
    <h1 id="emoji">üéØ</h1>
    <h2 id="currentUrl"></h2>
    <h3>Number of tabs:</h3>
    <input
      id="nbTabs"
      type="text"
      placeholder="Number of tabs"
      style="margin: 10px"
    />
    <h3>Interval (in ms):</h3>
    <input
      id="interval"
      type="text"
      placeholder="Interval in ms"
      style="margin: 10px"
    />
    <h3>Urls starting with http(s):</h3>
    <div id="options">
      <input
        id="add-custom-option"
        type="text"
        placeholder="Add an url"
        style="margin: 10px"
      />
    </div>

    <script>
      const options = document.querySelector("#options");
      const addCustomOptionButton =
        document.querySelector("#add-custom-option");
      const currentUrlText = document.getElementById("currentUrl");
      const emoji = document.getElementById("emoji");
      const intervalInput = document.querySelector("#interval");
      const nbTabsInput = document.querySelector("#nbTabs");
      var urls,
        interval,
        newTabs,
        nbTabs = 0;
      nbOpenedTabs = 0;
      init();

      function onlyUnique(value, index, array) {
        return array.indexOf(value) === index;
      }

      function getOptions(checked = false) {
        if (checked)
          return Array.from(
            options.querySelectorAll('input[type="checkbox"]:checked')
          );
        return Array.from(options.querySelectorAll('input[type="checkbox"]'));
      }

      function getOptionValues(checked = false) {
        return getOptions(checked).map((option) => option.value);
      }

      function getOptionsFromUrl(selected = false) {
        const paramName = selected ? "selectedUrls" : "urls";
        const url = new URL(window.location.href);
        const urlParams = new URLSearchParams(url.search);
        if (urlParams.has(paramName) && urlParams.get(paramName).length > 0) {
          return urlParams
            .get(paramName)
            .split(",")
            .filter(onlyUnique)
            .filter(isValidURL);
        }
        return [];
      }

      function getValueFromUrl(value) {
        const url = new URL(window.location.href);
        const urlParams = new URLSearchParams(url.search);
        if (urlParams.has(value) && urlParams.get(value).length > 0) {
          return urlParams.get(value);
        }
      }

      function getNbTabFromUrl() {
        return Math.max(getValueFromUrl("nbTabs") || 1, 1) ;
      }

      function getIntervalFromUrl() {
        return getValueFromUrl("interval") || 3000;
      }

      function getNbClosedTabs() {
        return newTabs
          ? nbTabs - newTabs.filter((tab) => (tab ? !tab.closed : false)).length
          : Math.max(nbTabs, 1);
      }

      function removeClosedTabs() {
        newTabs = newTabs
          ? newTabs.filter((tab) => (tab ? !tab.closed : false))
          : [];
      }

      function callURL(url) {
        if (urls.length === 0) {
          currentUrlText.innerText = "No urls selected";
          setTimeout(callURL, 1000, url);
        } else if (getNbClosedTabs() > 0) {
          removeClosedTabs();
          for (let i = 0; i < getNbClosedTabs(); i++) {
            newTabs.push(window.open(url, "mysimpleactionTab_" + nbOpenedTabs));
            nbOpenedTabs++;
          }
          if (getNbClosedTabs() > 0) {
            currentUrlText.innerText =
              "Popup blocked. Please enable popups for this website.";
            emoji.innerText = "‚ùå";
          } else {
            emoji.innerText = "üéØ";
          }
          setTimeout(callURL, 1000, url);
        } else {
          const currentUrlIndex = urls.indexOf(url);
          const newUrl = urls[(currentUrlIndex + 1) % urls.length];
          currentUrlText.innerText = newUrl;
          for (let i = 0; i < newTabs.length; i++) {
            newTabs[i].location = newUrl;
          }
          setTimeout(callURL, interval, newUrl);
        }
      }

      function isValidURL(url) {
        const urlPattern = /^(https?|ftp)?:\/\/[^\s/$.?#].[^\s]*$/i;
        return urlPattern.test(url);
      }

      function init() {
        const urlSelectedOptions = getOptionsFromUrl(true);
        const urlOptions = getOptionsFromUrl()
          .concat(urlSelectedOptions)
          .filter(onlyUnique);

        urlOptions.forEach((value) => {
          const optionFromUrl = createOption(
            value,
            urlSelectedOptions.includes(value)
          );
        });

        urls = urlSelectedOptions;
        interval = getIntervalFromUrl();
        nbTabs = getNbTabFromUrl();
        intervalInput.value = interval;
        nbTabsInput.value = nbTabs;

        updateURLParams();

        callURL(urls[0]);
      }

      function createOption(value, checked = false) {
        const customOption = document.createElement("div");
        customOption.className = "option";
        customOption.innerHTML = `
            <input type="checkbox" ${checked ? "checked" : ""} value="${value}">
            <label>${value}</label>
        `;
        return options.insertBefore(customOption, options.lastChild);
      }

      function updateURLParams() {
        const optionValues = getOptionValues();
        const selectedOptionValues = getOptionValues(true);
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set("interval", intervalInput.value);
        urlParams.set("nbTabs", nbTabsInput.value);
        urlParams.set("urls", optionValues.join(","));
        urlParams.set("selectedUrls", selectedOptionValues.join(","));
        history.replaceState(
          null,
          "",
          window.location.pathname + "?" + urlParams.toString()
        );
        urls = selectedOptionValues;
      }

      options.addEventListener("click", (event) => {
        if (event.target && event.target.tagName === "INPUT") {
          updateURLParams();
        }
      });

      intervalInput.addEventListener("change", (event) => {
        if (event.target && event.target.tagName === "INPUT") {
          interval = event.target.value;
          if (interval < 0) {
            alert("Interval should be a positive number");
            return;
          }
          updateURLParams();
        }
      });

      nbTabsInput.addEventListener("change", (event) => {
        if (event.target && event.target.tagName === "INPUT") {
          nbTabs = event.target.value;
          if (nbTabs < 0) {
            alert("Number of tabs should be a positive number");
            return;
          }
          updateURLParams();
        }
      });

      addCustomOptionButton.addEventListener("keydown", (event) => {
        if (
          event.key === "Enter" &&
          addCustomOptionButton.value.trim() !== ""
        ) {
          const _optionValues = getOptionValues();
          if (_optionValues.includes(addCustomOptionButton.value)) {
            alert("Url already exists");
            return;
          }
          if (!isValidURL(addCustomOptionButton.value)) {
            alert("Invalid URL, did you forget to add http(s):// ?");
            return;
          }
          createOption(addCustomOptionButton.value, true);
          updateURLParams();
          addCustomOptionButton.value = "";
        }
      });
    </script>
  </body>
</html>
